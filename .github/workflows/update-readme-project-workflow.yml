---
name: Update README.md

on:
  workflow_call:
    inputs:
      terragrunt_version:
        required: false
        default: "0.47.0"
        type: string
      terraform_version:
        required: false
        default: "1.5.0"
        type: string
      python_version:
        required: false
        default: "3.10"
        type: string
      jira_url:
        required: false
        default: "https://northvolt.atlassian.net/browse"
        type: string
      azure_portal_url:
        required: false
        default: "https://portal.azure.com/#@northvolt.com"
        type: string
    secrets:
      actions_gpg_private_key:
        description: 'GPG key to sign commits'
        required: true
      actions_gpg_passphrase:
        description: 'Passphrase for the GPG key'
        required: true

jobs:
  update_readme:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3.5.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Setup Terragrunt
        uses: autero1/action-terragrunt@v1.3.0
        with:
          terragrunt_version: ${{ inputs.terragrunt_version }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2.0.3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Setup python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Execute README.md update script
        run: python .github/workflows/readme.py
        env:
          ROOT_DIR: ${{ github.workspace }}
          JIRA_URL: ${{ inputs.jira_url }}
          AZURE_PORTAL_URL: ${{ inputs.azure_portal_url }}

      - name: Check if any file to commit
        id: check-to-commit
        run: git diff --exit-code README.md PROJECTS.md > /dev/null || echo "commit=true" >> $GITHUB_OUTPUT

      - name: Import bot's GPG key for signing commits
        id: import-gpg
        uses: crazy-max/ghaction-import-gpg@6f6401f19d4d5866d07e9026b6468c69596e9470
        with:
          gpg_private_key: ${{ secrets.actions_gpg_private_key }}
          passphrase: ${{ secrets.actions_gpg_passphrase }}
          git_config_global: true
          git_user_signingkey: true
          git_commit_gpgsign: true
        if: steps.check-to-commit.outputs.commit

      - name: Add and commit fmt changes
        uses: EndBug/add-and-commit@fc734f817560acc116627c6133815f6289cd96ce
        with:
          add: README.md PROJECTS.md
          message: 'Update README.md and PROJECTS.md file with new projects'
          author_name: ${{ steps.import-gpg.outputs.name }}
          author_email: ${{ steps.import-gpg.outputs.email }}
          push: true
        if: steps.check-to-commit.outputs.commit
